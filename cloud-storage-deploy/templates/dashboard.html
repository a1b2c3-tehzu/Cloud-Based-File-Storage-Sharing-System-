{% extends "base.html" %}

{% block title %}Dashboard - Cloud Storage System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Breadcrumb Navigation -->
        {% if breadcrumb %}
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('file.dashboard') }}">
                        <i class="bi bi-house"></i> Home
                    </a>
                </li>
                {% for folder in breadcrumb %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('file.dashboard', folder_id=folder.id) }}">{{ folder.name }}</a>
                </li>
                {% endfor %}
            </ol>
        </nav>
        {% endif %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-cloud-fill"></i> 
                {% if current_folder %}{{ current_folder.name }}{% else %}My Files{% endif %}
            </h2>
            <div>
                <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                    <i class="bi bi-folder-plus"></i> New Folder
                </button>
                <a href="{{ url_for('file.upload', folder_id=current_folder.id if current_folder else None) }}" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> Upload Files
                </a>
            </div>
        </div>
        
        <!-- Search and Controls -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search files...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="sortSelect">
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="size_desc">Largest First</option>
                    <option value="size_asc">Smallest First</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterSelect">
                    <option value="all">All Files</option>
                    <option value="image">Images</option>
                    <option value="document">Documents</option>
                    <option value="archive">Archives</option>
                    <option value="other">Other</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Folders Section -->
{% if folders %}
<div class="row mb-4">
    <div class="col-12">
        <h5><i class="bi bi-folder"></i> Folders</h5>
        <div class="row">
            {% for folder in folders %}
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 folder-card" onclick="navigateToFolder({{ folder.id }})" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <i class="bi bi-folder-fill text-warning" style="font-size: 2.5rem;"></i>
                        <h6 class="card-title mt-2">{{ folder.name }}</h6>
                        <small class="text-muted">{{ folder.created_at.strftime('%Y-%m-%d') if folder.created_at else 'Unknown' }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Files Section -->
{% if files %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th><i class="bi bi-file-earmark"></i> File Name</th>
                                <th data-sort="size" class="sortable"><i class="bi bi-hdd"></i> Size</th>
                                <th data-sort="date" class="sortable"><i class="bi bi-calendar"></i> Upload Date</th>
                                <th><i class="bi bi-gear"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fileTableBody">
                            {% for file in files %}
                            <tr data-file-id="{{ file.id }}">
                                <td>
                                    <i class="bi-file-earmark text-muted" style="font-size: 1.2rem;"></i>
                                    <span class="file-name">{{ file.file_name }}</span>
                                </td>
                                <td>
                                    <span class="file-size">{{ file.file_size or 0 }}</span>
                                </td>
                                <td><span class="file-date">{{ file.created_at.strftime('%Y-%m-%d %H:%M') if file.created_at else 'Unknown' }}</span></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="previewFile({{ file.id }})" 
                                                title="Preview">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <a href="{{ url_for('file.download_file', file_id=file.id) }}" 
                                           class="btn btn-sm btn-outline-primary" title="Download">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="showMoveModal({{ file.id }}, '{{ file.file_name|e }}')" 
                                                title="Move to folder">
                                            <i class="bi bi-folder-symlink"></i>
                                        </button>
                                        <a href="{{ url_for('share.generate_share', file_id=file.id) }}" 
                                           class="btn btn-sm btn-outline-info" title="Share">
                                            <i class="bi bi-share"></i>
                                        </a>
                                        <a href="{{ url_for('file.delete_file', file_id=file.id) }}" 
                                           class="btn btn-sm btn-outline-danger" 
                                           onclick="return confirm('Are you sure you want to delete this file?')"
                                           title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Empty State -->
{% if not folders and not files %}
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-cloud-upload text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No files yet</h4>
            <p class="text-muted">Start by uploading your first file to the cloud storage.</p>
            <a href="{{ url_for('file.upload') }}" class="btn btn-primary">
                <i class="bi bi-cloud-upload"></i> Upload Your First File
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Storage Statistics -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-files text-primary" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">{{ files|length }}</h5>
                <p class="card-text text-muted">Total Files</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-shield-check text-success" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Secure</h5>
                <p class="card-text text-muted">AWS S3 Storage</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-share text-info" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Shareable</h5>
                <p class="card-text text-muted">Secure Links</p>
            </div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('folder.create_folder') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input type="text" class="form-control" id="folderName" name="folder_name" required>
                    </div>
                    <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Folder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Move File Modal -->
<div class="modal fade" id="moveFileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Move File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="moveFileForm">
                <div class="modal-body">
                    <p>Move file: <strong id="moveFileName"></strong></p>
                    <div class="mb-3">
                        <label for="targetFolder" class="form-label">Target Folder</label>
                        <select class="form-select" id="targetFolder" name="target_folder_id">
                            <option value="">Root (Home)</option>
                            <!-- Folder options will be populated by JavaScript -->
                        </select>
                    </div>
                    <input type="hidden" id="moveFileId" name="file_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move File</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadFromPreview">Download</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Navigate to folder
function navigateToFolder(folderId) {
    window.location.href = `/dashboard?folder_id=${folderId}`;
}

// Show move file modal
function showMoveModal(fileId, fileName) {
    document.getElementById('moveFileName').textContent = fileName;
    document.getElementById('moveFileId').value = fileId;
    
    // Load folder options
    loadFolderOptions();
    
    const modal = new bootstrap.Modal(document.getElementById('moveFileModal'));
    modal.show();
}

// Load folder options for move modal
function loadFolderOptions() {
    fetch('/api/folder_tree')
        .then(response => response.json())
        .then(folders => {
            const select = document.getElementById('targetFolder');
            select.innerHTML = '<option value="">Root (Home)</option>';
            
            function addFolderOptions(folderList, level = 0) {
                folderList.forEach(folder => {
                    const indent = 'ã€€'.repeat(level);
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = indent + folder.name;
                    select.appendChild(option);
                    
                    if (folder.children && folder.children.length > 0) {
                        addFolderOptions(folder.children, level + 1);
                    }
                });
            }
            
            Object.values(folders).forEach(folder => {
                addFolderOptions([folder]);
            });
        })
        .catch(error => console.error('Error loading folders:', error));
}

// Set move form action
document.getElementById('moveFileForm').addEventListener('submit', function(e) {
    const fileId = document.getElementById('moveFileId').value;
    this.action = `/move_to_folder/${fileId}`;
});

// Preview file function
function previewFile(fileId) {
    // Option 1: Open in new window
    window.open(`/preview/${fileId}`, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    
    // Option 2: Load in modal (commented out for now)
    // loadPreviewInModal(fileId);
}

// Load preview in modal (alternative implementation)
function loadPreviewInModal(fileId) {
    fetch(`/api/preview-info/${fileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading preview: ' + data.error);
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const contentDiv = document.getElementById('previewContent');
            const downloadBtn = document.getElementById('downloadFromPreview');
            
            // Set download button
            downloadBtn.onclick = () => {
                window.location.href = `/download_file/${fileId}`;
            };
            
            // Load preview based on file type
            if (data.file_type === 'image') {
                contentDiv.innerHTML = `<img src="/api/preview-image/${fileId}" class="img-fluid" alt="${data.file_name}">`;
            } else if (data.file_type === 'pdf') {
                contentDiv.innerHTML = `<iframe src="/api/preview-pdf/${fileId}" width="100%" height="600px"></iframe>`;
            } else if (data.file_type === 'text' || data.file_type === 'code') {
                fetch(`/api/preview-text/${fileId}`)
                    .then(response => response.text())
                    .then(text => {
                        contentDiv.innerHTML = `<pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">${text}</pre>`;
                    });
            } else {
                contentDiv.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">Preview Not Available</h5>
                        <p class="text-muted">This file type cannot be previewed directly.</p>
                    </div>
                `;
            }
            
            modal.show();
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            alert('Error loading preview');
        });
}

// Sort files functionality
function sortFiles(sortType) {
    const fileTableBody = document.getElementById('fileTableBody');
    const rows = Array.from(fileTableBody.querySelectorAll('tr[data-file-id]'));
    
    rows.sort((a, b) => {
        const aData = {
            name: a.querySelector('.file-name').textContent.trim(),
            size: parseInt(a.querySelector('.file-size').textContent) || 0,
            date: a.querySelector('.file-date').textContent.trim()
        };
        
        const bData = {
            name: b.querySelector('.file-name').textContent.trim(),
            size: parseInt(b.querySelector('.file-size').textContent) || 0,
            date: b.querySelector('.file-date').textContent.trim()
        };
        
        switch(sortType) {
            case 'name_asc':
                return aData.name.localeCompare(bData.name);
            case 'name_desc':
                return bData.name.localeCompare(aData.name);
            case 'date_asc':
                return new Date(aData.date) - new Date(bData.date);
            case 'date_desc':
                return new Date(bData.date) - new Date(aData.date);
            case 'size_asc':
                return aData.size - bData.size;
            case 'size_desc':
                return bData.size - aData.size;
            default:
                return 0;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => fileTableBody.appendChild(row));
}

// Sort dropdown event listener
document.addEventListener('DOMContentLoaded', function() {
    const sortSelect = document.getElementById('sortSelect');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            sortFiles(this.value);
        });
    }
    
    // Folder card hover effect
    const folderCards = document.querySelectorAll('.folder-card');
    folderCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}
